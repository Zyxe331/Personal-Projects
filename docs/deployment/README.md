# Deployment Documentation
All the information related to deploying the application to the AWS instance will be in this directory. It is strongly suggested to consult the documentation in the list of helpful links. These are all included for your benefit so that you do not have to reverse engineer the process we have created.

### Helpful links:
- [Bitnami Docs for the AWS Node.js instance](https://docs.bitnami.com/aws/infrastructure/nodejs/)
- [Apache Virtual Hosts documentation](https://httpd.apache.org/docs/2.4/vhosts/)
- [pm2(process manager) documentation](https://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/)
- [connecting to remote server using vs code and putty key](https://code.visualstudio.com/docs/remote/troubleshooting#_reusing-a-key-generated-in-puttygen)

## Connecting to the server
Connecting to the server through SSH can be done through any ssh client, but [putty](https://www.putty.org/) is our one of choice. All tutorials for the required information is through putty and it's a good client. In order to connect to the server you will need the URL/IP for the server, username, and the port to connect to. At the current configuration this should be `bitnami@www.vitaprayer.com` at port 22. Not only that, but you will need to download the private key from AWS Lightsail and turn the key into a ppk for putty to use. For more information, check out the [AWS docs for that.](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html)

## Starting the server
Assuming the server is already running, you can restart the backed api by calling `pm2 restart index`. If you want to stop it `pm2 stop index` and to start  `pm2 start index`. Using pm2 makes it quite easy to manage running processes, and you can see the log of for proccesses by entering `pm2 monit`.
- One thing the 2020-2021 team did not investigate are custom scripts for pm2. If you find it worthwhile to write a script to update the database and restart the server, by all means do so! for more informationand other commands, or run `pm2 --help`.
- It is worth mentioning that the front end SPA(single page application) cannot be 'restarted'. This is because it is a static set of files generated by angular and served by apache. If you need to update the front end, you will either need to build the app using ionic locally and then upload the www directory, or build it on the server and move the www directory.

## Updating the server
The backend api and database can get updates through git. Make sure that the server has an [ssh key](https://docs.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) so that it does not require user credentials to pull down new code. If no key exists, generate a new one on the server and then add the key to the deploy keys inside the github repo. After that has been done, you can use git to pull in new code!
- Change to backend api: `git pull origin <branchname>` then pm2 restart index
- Change to database: **TODO: ADD DB PROCCESS**
- Change to client: build code locally, then `pscp -P 22 -i <path_to_server_key> -r ./www/* bitnami@test.vitaprayer.com:/home/bitnami/vetTest/www`

## Backend API configuration
Just like developing locally, the server needs a .env file that includes the variables for the api to be able to connect to the DB and whatnot. Please see the server documentation for more specific information on what is included, and use vim to see what is in the current server configuration for the different environments. I.E vetTest/Vet-20-21/server/.env

## Apache Configuration
Inside the `bitnami-ssl.conf` file is where all the sub domain information is contained. Setting up an environment for testing and one for production use is all done here. When the angular application is built and then served statically, that file path is specified here. Proxies for ports and apis are also configured here. Please review this information carefully and consult the bitnami and apache documentation for more information on how to edit this configuration.
- Restart apache with this command: `sudo /opt/bitnami/ctlscript.sh restart apache`
- Apache virtual hosts configuration is inside /opt/bitnami/apache2/conf/bitnami/bitnami-ssl.conf

## Renewing the site certificate:
The certificate has been issued by [Cert-bot](https://certbot.eff.org/). If the certificate has expired, there are a couple of things that need to be done:
 - Get the new cert from cert bot by running ```sudo certbot renew```
 - If autorenew is not allowed, please reissue the cert using methods that will allow for autorenewal. It is possible that the cert must be recertified using DNS challenges.

## Server Credentials:
 - Root pwd: hphwRLl80Lcj
 - SQL ROOT PWD: SQLRoot333
 - An old password that might be used somewhere: V3tCSc@pSt0Ne
 - Refer to the .env on the server to verify any differences with this documentation.

## Rollback Plan
What will happen if a bad change gets deployed to the production environment? Will data be rolled back? Will the server version be rolled back? WIP
