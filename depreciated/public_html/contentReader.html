<!-- contentReader.html -->
<!DOCTYPE html>
<html>

<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="static/css/common.css" />
    <link rel="stylesheet" type="text/css" href="static/css/contentReaderTemplate.css" />

    <script type="text/javascript" src="static/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="static/js/settings.js"></script>
    <script type="text/javascript" src="static/js/sessionHandler.js"></script>

    <title>Devotional</title>
</head>

<body>
    <div id="screen">

        <a href="devos.html">
            <div id="exitbtn">
                <img id="exitbtnimg" src="static/imgs/escapeReader.png" />
            </div>
        </a>
        <a id="a-leftbtn">
            <div id="leftbtn">
                <img id="leftbtnimg" src="static/imgs/leftArrow.png" />
            </div>
        </a>
        <div id="readerContent">
            <p id="readerText"></p>
            <!--paragraphs are added via javascript-->
        </div>
        <a id="a-rightbtn">
            <div id="rightbtn">
                <img id="rightbtnimg" src="static/imgs/rightArrow.png" />
            </div>
        </a>
    </div>
</body>

<script type="text/javascript">
    //Get cycle content
    $(document).ready(function () {
        var pid;
        //Get PID from sessionHandler.js
        handleSessions(function (pid) {
            var cycleID = getUrlVars()["cycle"];
            //Default to cycle 0 (error message) in the case that no parameter was provided
            if (cycleID == null) {
                cycleID = 0;
            }
            var position = getUrlVars()["pos"];
            if (position == null) {
                position = 0;
            }
            var dataString = "CycleID=" + cycleID + "&pid=" + pid;
            $.ajax({
                url: "http://vet.cscapstone.us/virtual/phpcode/readcontent.php",
                type: "POST",
                context: document.body,
                data: dataString,
                success: function (data) {
                    var returnArray = JSON.parse(data);
                    if (position > returnArray.length) {
                        window.location.href = "devos.html";
                    }
                    //Sort the array by position
                    returnArray.sort(function (a, b) {
                        return a.Position - b.Position;
                    });
                    if (position == returnArray.length) {
                        cycleEntry = "You have reached the end of the cycle";
                    }
                    else {
                        var cycleEntry = returnArray[position].Text;
                    }

                    //Check if cycle entry is a tag reference
                    //<tag> references any prayer request with that tag
                    if (cycleEntry.charAt(0) == '<') {
                        //Get the list of tags in order
                        //Chop the leading < and closing > off
                        cycleEntry = cycleEntry.substring(1, cycleEntry.length - 1);
                        //Get the tag values into an array
                        var tagArray = cycleEntry.split('><');

                        //Check for prayer requests that have the tags in order (if there is no prayer request with the first tag, then check the other)
                        findTags(0, tagArray);

                    }
                    //{tag} references only resolved prayer requests with that tag
                    else if (cycleEntry.charAt(0) == '{') {
                        //Get the list of tags in order
                        //Chop the leading { and closing } off
                        cycleEntry = cycleEntry.substring(1, cycleEntry.length - 1);
                        //Get the tag values into an array
                        var tagArray = cycleEntry.split('}{');

                        //Check for resolved prayer requests that have the tags in order (if there is no prayer request with the first tag, then check the other)
                        findResolvedTags(0, tagArray);
                    }
                    //Regular entry content
                    else {
                        //Populate page with content
                        var textarea = document.getElementById("readerText");
                        textarea.textContent = cycleEntry;
                    }

                    //Attach values to buttons
                    if (position > 0) {
                        buildButton("a-leftbtn", (position * 1 - 1), "l");
                    }
                    else {
                        buildButton("a-leftbtn", -1, "l");
                    }
                    if (position <= returnArray.length) {
                        buildButton("a-rightbtn", (position * 1 + 1), "r"); //The position * 1 is to force it into integer addition instead of concatenation
                    }
                    else {
                        window.location.href = "devos.html";
                    }
                }
            });
        });
    });

    function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
            vars[key] = value;
        });
        return vars;
    }

    function populateReader(position) {

    }

    //Select cycle
    function buildButton(id, position, dir) {
        var button = document.getElementById(id);
        var cycleID = getUrlVars()["cycle"];
        if (position == -1) {
            button.setAttribute("onclick", "alert(\"This is the first element in the cycle\")");
        }
        else {
            button.setAttribute("href", "contentReader.html?cycle=" + cycleID + "&pos=" + position + "&dir=" + dir);
        }

        //var selection = document.getElementById("cyclelist").value;
        //if (selection == "") {
        //    alert("Choose a content cycle.");
        //}
        //else {
        //    window.location.href = "contentReader.html" + "?cycle=" + selection;
        //}

    }

    //Handle <> tags
    function findTags(i, tagArray) {
        handleSessions(function (pid) {
            dataString = "pid=" + pid + "&tag=" + tagArray[i];
            $.ajax({
                url: "http://vet.cscapstone.us/virtual/phpcode/getTagged.php",
                type: "POST",
                context: document.body,
                data: dataString,
                success: function (data) {
                    //If there are more tags to check recursively call the function
                    if (data == "false" && i < tagArray.length) {
                        return findTags(++i, tagArray);
                    }
                    //If there are no more tags
                    else if (data == "false") {
                        var dir = getUrlVars()["dir"];
                        var cycleID = getUrlVars()["cycle"];
                        //Default to cycle 0 (error message) in the case that no parameter was provided
                        if (cycleID == null) {
                            cycleID = 0;
                        }
                        var position = getUrlVars()["pos"];
                        if (position == null) {
                            position = 0;
                        }

                        //Go to next element (or previous element if coming from the opposite direction)
                        if (dir == "r") {
                            position++;
                            window.location.href = "contentReader.html?cycle=" + cycleID + "&pos=" + position + "&dir=" + dir;
                        }
                        else if (dir == "l") {
                            position--;
                            window.location.href = "contentReader.html?cycle=" + cycleID + "&pos=" + position + "&dir=" + dir;
                        }
                    }
                    //Call displayPrayer with the returned RID
                    else {
                        displayPrayer(data, tagArray[i]);
                    }
                }
            });
        });
    }
    //Handle {} tags
    function findResolvedTags(i, tagArray) {
        handleSessions(function (pid) {
            dataString = "pid=" + pid + "&tag=" + tagArray[i];
            $.ajax({
                url: "http://vet.cscapstone.us/virtual/phpcode/getTaggedResolved.php",
                type: "POST",
                context: document.body,
                data: dataString,
                success: function (data) {
                    //If there are more tags to check recursively call the function
                    if (data == "false" && i < tagArray.length) {
                        return findResolvedTags(++i, tagArray);
                    }
                    //If there are no more tags
                    else if (data == "false") {
                        //Go to next element (or previous element if coming from the opposite direction)
                        var dir = getUrlVars()["dir"];
                        var cycleID = getUrlVars()["cycle"];
                        //Default to cycle 0 (error message) in the case that no parameter was provided
                        if (cycleID == null) {
                            cycleID = 0;
                        }
                        var position = getUrlVars()["pos"];
                        if (position == null) {
                            position = 0;
                        }

                        //Go to next element (or previous element if coming from the opposite direction)
                        if (dir == "r") {
                            position++;
                            window.location.href = "contentReader.html?cycle=" + cycleID + "&pos=" + position + "&dir=" + dir;
                        }
                        else if (dir == "l") {
                            position--;
                            window.location.href = "contentReader.html?cycle=" + cycleID + "&pos=" + position + "&dir=" + dir;
                        }
                    }
                    //Call displayPrayer with the returned RID
                    else {
                        displayResolvedPrayer(data, tagArray[i]);
                    }
                }
            });
        });
    }
    //Display prayer
    function displayPrayer(rid, tagName) {
        handleSessions(function (pid) {
            //Populate page with content
            var dataString = "rid=" + rid + "&pid=" + pid;
            if ($.trim(rid).length > 0) {

                //Get request body
                $.ajax({
                    url: "http://vet.cscapstone.us/virtual/phpcode/viewPrayerEntry.php",
                    type: "POST",
                    context: document.body,
                    data: dataString,
                    success: function (data) {
                        var returnArray = JSON.parse(data);
                        //Add elements to list
                        //Populate content reader with content
                        var textarea = document.getElementById("readerText");
                        textarea.textContent = "You have prayed about " + tagName + ": " + returnArray[0].Title;
                    }
                });
            }

        });
    }

    //Display resolved prayer
    function displayResolvedPrayer(rid, tagName) {
        handleSessions(function (pid) {
            //Populate page with content
            var dataString = "rid=" + rid + "&pid=" + pid;
            if ($.trim(rid).length > 0) {

                //Get request body
                $.ajax({
                    url: "http://vet.cscapstone.us/virtual/phpcode/viewPrayerEntry.php",
                    type: "POST",
                    context: document.body,
                    data: dataString,
                    success: function (data) {
                        var returnArray = JSON.parse(data);
                        //Add elements to list
                        //Populate content reader with content
                        var textarea = document.getElementById("readerText");
                        textarea.textContent = "You resolved a prayer request about " + tagName + ": " + returnArray[0].Title;
                    }
                });
            }

        });
    }

</script>

</html>